import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.filters import Command
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.utils.keyboard import InlineKeyboardBuilder

from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from API import TOKEN

dp = Dispatcher()



async def main():
    bot = Bot(token = TOKEN)
    await dp.start_polling(bot)


class User(StatesGroup):
    name = State()

user_inputs = ['внести данные','редактировать данные', 'посмотреть данные']

product_input = {
    "type" : "eat",
    "product" : "fish",
    "price" : 2000

}



async def kb_build():
    kb = InlineKeyboardBuilder()
    for k_b in user_inputs:
        kb.add(InlineKeyboardButton(
            text=k_b, callback_data=f'item_{k_b}'
        ))
    return kb.adjust(2).as_markup()


async def kb_next():
    nb = InlineKeyboardBuilder()
    nb.button(
        text='начать', callback_data= "next"
    )
    return nb.adjust(2).as_markup()

async def kb_optional():
    rb = InlineKeyboardBuilder()
    rb.button(
        text = 'новая кнопка', callback_data = 'next'
    )
    return rb.adjust(2).as_markup()


##обработка кнопок
@dp.callback_query(F.data.startswith("item_"))
async def handle_items(callback: CallbackQuery, state: FSMContext):
    value = callback.data.split("_")[1]

    text = "\n".join(f"{k}: {v}" for k, v in product_input.items())

    if value == user_inputs[1]:
        await start_reg(callback, state)
        # await callback.message.answer(f'Ты выбрал: {value}', reply_markup=await kb_build())

    if value == user_inputs[2]:
        await callback.message.answer(text)

    if value == user_inputs[3]:
        await callback.message.answer('панель', reply_markup=await kb_optional())

@dp.callback_query(F.data == user_inputs[1])
async def start_reg(callback: CallbackQuery, state: FSMContext):
    await state.set_state(User.name)
    await callback.message.answer("Введи текст кнопки")


# @dp.callback_query(F.data == user_inputs[3])
# async def optional(callback: CallbackQuery):




@dp.message(User.name)
async def cmd_reg(message: Message, state: FSMContext):
    data = message.text
    user_inputs.append(data)
    await message.answer('Сохранил')
    print(data)
    await state.clear()




@dp.callback_query(F.data == 'next')
async def kb_previous(callback: CallbackQuery):
    await callback.message.answer('панель', reply_markup=await kb_build())


@dp.message(Command('start'))
async def cmd_s(message: Message):
    await message.answer('привет', reply_markup=await kb_next())







# @dp.message()
# async def save_input(message: Message):
#     text = message.text
#     user_inputs.append(text)  # сохраняем в список
#     await message.answer(f"Сохранил: {text}\nТекущий список: {user_inputs}")
#



if __name__ == '__main__':
    asyncio.run(main())
